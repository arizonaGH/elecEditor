<!--
  Copyright (c) 2006-2013, JGraph Ltd
  
  Codec example for mxGraph. This example demonstrates dynamically
  creating a graph from XML and encoding the model into XML, as well
  as changing the default style for edges in-place.
-->
<html>
<head>
	<title>Codec example for mxGraph</title>
	<script type="text/javascript" src="../../../src/js/jquery/jquery-3.3.1.js"></script>
	<!-- Sets the basepath for the library if not in same directory -->
	<script type="text/javascript">
		mxBasePath = '../../../src';
	</script>

	<!-- Loads and initializes the library -->
	<script type="text/javascript" src="../../../src/js/mxClient.js"></script>
	<script type="text/javascript" src="sanitizer/sanitizer.min.js"></script>
	<script type="text/javascript" src="js/Init.js"></script>
	<script type="text/javascript" src="monitor/mtGraph.js"></script>

	<!-- Example code -->
	<script type="text/javascript">
        var urlParams = (function(url)
        {
            var result = new Object();
            var idx = url.lastIndexOf('?');

            if (idx > 0)
            {
                var params = url.substring(idx + 1).split('&');

                for (var i = 0; i < params.length; i++)
                {
                    idx = params[i].indexOf('=');

                    if (idx > 0)
                    {
                        result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
                    }
                }
            }

            return result;
        })(window.location.href);
		// Program starts here. Creates a sample graph in the
		// DOM node with the specified ID. This function is invoked
		// from the onLoad event handler of the document (see below).

		function loadFile(id){
            var ret = (function($) {
                return $.ajax({
                    url : BASE_URL + OPEN_URL+"/"+id,
                    type : 'get',
                    async: false,
                });
            })(jQuery);

            if (ret.status == 200) {
                return ret.responseJSON;
            }
            else {
                mxUtils.error('Get graph failed.', 200, false);
                return null;
			}

		}

		function main()
		{
            if (!mxClient.isBrowserSupported())
            {
                // Displays an error message if the browser is not supported.
                mxUtils.error('Browser is not supported!', 200, false);
                return;
            }

            if(!("id" in urlParams))
            {
                mxUtils.error('Please specify id of the graph', 200, false);
                return;
            }

            var id = urlParams.id;

            // Loads the stencils into the registry
            var STENCIL_PATH = 'stencils';
            var req = mxUtils.load(STENCIL_PATH + '/electronic.xml');
            var root = req.getDocumentElement();
            var shape = root.firstChild;

            while (shape != null)
            {
                if (shape.nodeType == mxConstants.NODETYPE_ELEMENT)
                {
                    mxStencilRegistry.addStencil("mxgraph.electronic."+shape.getAttribute('name').toLocaleLowerCase(), new mxStencil(shape));
                }

                shape = shape.nextSibling;
            }

            var data = loadFile(id);
            var container = document.getElementById("container");
            document.title = data.name;

            var xml  = data.content;
            var xmlDocument = mxUtils.parseXml(xml);

            if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel')
            {
                var decoder = new mxCodec(xmlDocument);
                var node = xmlDocument.documentElement;

                container.innerHTML = '';

                var graph = new mtGraph(container);

                graph.centerZoom = false;
                graph.setTooltips(false);
                graph.setEnabled(false);



                // graph.addListener(mxEvent.GESTURE, function(sender, eo)
                // {
                //     var evt = eo.getProperty('event');
                //     var state = graph.view.getState(eo.getProperty('cell'));
                //
                //     if (graph.isEnabled() && graph.isCellResizable(state.cell) && Math.abs(1 - evt.scale) > 0.2)
                //     {
                //         var scale = graph.view.scale;
                //         var tr = graph.view.translate;
                //
                //         var w = state.width * evt.scale;
                //         var h = state.height * evt.scale;
                //         var x = state.x - (w - state.width) / 2;
                //         var y = state.y - (h - state.height) / 2;
                //
                //         var bounds = new mxRectangle(graph.snap(x / scale) - tr.x,
                //             graph.snap(y / scale) - tr.y, graph.snap(w / scale), graph.snap(h / scale));
                //         graph.resizeCell(state.cell, bounds);
                //         eo.consume();
                //     }
                // });

                decoder.decode(node, graph.getModel());
                graph.resizeContainer = true;

            }

            /////
            // Adds required resources (disables loading of fallback properties, this can only
            // be used if we know that all keys are defined in the language specific file)
            // mxResources.loadDefaultBundle = false;
            // var bundle ="resources/grapheditor.txt";
            //
            // mxUtils.getAll([bundle, STYLE_PATH + '/default.xml'], function(xhr)
            // {
            //     // Adds bundle text to resources
            //     mxResources.parse(xhr[0].getText());
            //
            //     // Configures the default graph theme
            //     var themes = new Object();
            //     themes[Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();
            //
            //     var data = loadFile(id);
            //     var container = document.getElementById("container");
            //     document.title = data.name;
            //
            //     var xml  = data.content;
            //     var xmlDocument = mxUtils.parseXml(xml);
            //
            //     if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel')
            //     {
            //         var decoder = new mxCodec(xmlDocument);
            //         var node = xmlDocument.documentElement;
            //
            //         container.innerHTML = '';
            //
            //         var graph = new Graph(container);
            //
            //         graph.centerZoom = false;
            //         graph.setTooltips(false);
            //         graph.setEnabled(false);
            //
            //         decoder.decode(node, graph.getModel());
            //         graph.resizeContainer = true;
            //
            //     }
            //
            //
            // }, function()
            // {
            //     document.body.innerHTML = '<center style="margin-top:10%;">Error loading resource files. Please check browser console.</center>';
            // });
		};
	</script>
</head>
<body>
    <div id="container" style="overflow:hidden;position:relative;background-color:black;cursor:default;"></div>
	<script type="text/javascript">
		main();
	</script>
</body>
</html>
